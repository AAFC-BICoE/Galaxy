<tool id="seqdb_pull_seqs" name="Load Sequences from SeqDB" version="@WRAPPER_VERSION@">
  <description> through web services. Produces a fasta file of the specified sequences. </description>
  <macros>
    <import>macros.xml</import>
  </macros>
  <expand macro="requirements" />
  <expand macro="stdio" />
  
  <command>
      pull_seqdb_seqs -c $config_file $pull_type_cond.pull_type
        #if $pull_type_cond.pull_type != "its"
	    #if $pull_type_cond.pull_type == "raw"
		#if $pull_type_cond.return_type_cond.return_type == "fastq" or $pull_type_cond.return_type_cond.return_type == "fasta"
			-r $pull_type_cond.return_type_cond.return_type
		#end if
            #end if

            #if $pull_type_cond.specimen_nums
                --specNums "$pull_type_cond.specimen_nums"
            #end if
        
            #if $pull_type_cond.sequence_name
                --seqName  $pull_type_cond.sequence_name
            #end if

	    #if $pull_type_cond.sample_name
		--sampleName $pull_type_cond.sample_name
	    #end if

            #if $pull_type_cond.region_name
                --geneRegion  $pull_type_cond.region_name
            #end if

            #if $pull_type_cond.project_name
                --projectName  $pull_type_cond.project_name
            #end if

            #if $pull_type_cond.collection_code
                --collectionCode  $pull_type_cond.collection_code
            #end if

            #if $pull_type_cond.taxon_value
                --taxRank $pull_type_cond.taxon_rank --taxValue $pull_type_cond.taxon_value
            #end if

            #if $pull_type_cond.output_taxonomy
            	-t 
            #end if
        #end if 
  </command>

  <inputs>
      <param name="config_file" type="data" format="data" label="Sequence Database Configuration File *" help="Generated by SeqDB Configuration tool." optional="False" />
      
      <conditional name="pull_type_cond">
          <param name="pull_type" type="select" label="Select which sequences you would like to load *">
              <option value="consensus">Consensus sequences</option>
              <option value="raw">Raw sequences</option>
	      <option value="all">All Sequences</option>	
              <option value="its" help="ITS sequences are defined as sequences linked to a region which has ITS region symbols in its name.">ITS sequences</option>
          </param>
          <when value="raw">
	      <conditional name="return_type_cond">
		   <param name="return_type" type="select" label="Sequence file output format" display="radio">
		       <option value="fasta">Fasta</option>
		       <option value="fastq">Fastq</option>
		   </param>
              </conditional> 
              <param name="specimen_nums" type="text" label="Filter on Specimen Identifier(s). Separate multiple by comma." optional="True" />
              <param name="sequence_name" type="text" label="Filter on Sequence Name (keyword)" optional="True" />
	      <param name="sample_name" type="text" label="Filter on Sample Name (keyword)" optional="True" />
              <param name="region_name" type="text" label="Filter on Region Name (keyword)" optional="True" />
              <param name="project_name" type="text" label="Filter on Project Name (keyword)" optional="True" />
              <param name="collection_code" type="text" label="Filter on Collection Code" optional="True" />
              <param name="taxon_rank" type="select" label="Filter on Taxonomic Rank " optional="True" >
                  <option value="species">Species</option>
                  <option value="genus">Genus</option>
                  <option value="family">Family</option>
                  <option value="order">Order</option>
                  <option value="class">Class</option>
                  <option value="phylum">Phylum</option>
              </param>
              <param name="taxon_value" type="text" label="Taxonomic Value (for the Taxonomic Rank above) " optional="True" />
              <param name="output_taxonomy" type="boolean" label="Output taxonomy file?" optional="True" checked="False" />
          </when>
          <when value="consensus">
              <param name="specimen_nums" type="text" label="Filter on Specimen Identifier(s). Separate multiple by comma." optional="True" />
              <param name="sequence_name" type="text" label="Filter on Sequence Name (keyword)" optional="True" />
	      <param name="sample_name" type="text" label="Filter on Sample Name (keyword)" optional="True" />
              <param name="region_name" type="text" label="Filter on Region Name (keyword)" optional="True" />
              <param name="project_name" type="text" label="Filter on Project Name (keyword)" optional="True" />
              <param name="collection_code" type="text" label="Filter on Collection Code" optional="True" />
              <param name="taxon_rank" type="select" label="Filter on Taxonomic Rank " optional="True" >
                  <option value="species">Species</option>
                  <option value="genus">Genus</option>
                  <option value="family">Family</option>
                  <option value="order">Order</option>
                  <option value="class">Class</option>
                  <option value="phylum">Phylum</option>
              </param>
              <param name="taxon_value" type="text" label="Taxonomic Value (for the Taxonomic Rank above)" optional="True" />
              <param name="output_taxonomy" type="boolean" label="Output taxonomy file?" optional="True" checked="False" />
          </when>
          <when value="all">
              <param name="specimen_nums" type="text" label="Filter on Specimen Identifier(s). Separate multiple by comma." optional="True" />
              <param name="sequence_name" type="text" label="Filter on Sequence Name (keyword)" optional="True" />
	      <param name="sample_name" type="text" label="Filter on Sample Name (keyword)" optional="True" />
              <param name="region_name" type="text" label="Filter on Region Name (keyword)" optional="True" />
              <param name="project_name" type="text" label="Filter on Project Name (keyword)" optional="True" />
              <param name="collection_code" type="text" label="Filter on Collection Code" optional="True" />
              <param name="taxon_rank" type="select" label="Filter on Taxonomic Rank " optional="True" >
                  <option value="species">Species</option>
                  <option value="genus">Genus</option>
                  <option value="family">Family</option>
                  <option value="order">Order</option>
                  <option value="class">Class</option>
                  <option value="phylum">Phylum</option>
              </param>
              <param name="taxon_value" type="text" label="Taxonomic Value (for the Taxonomic Rank above)" optional="True" />
              <param name="output_taxonomy" type="boolean" label="Output taxonomy file?" optional="True" checked="False" />
          </when>
          <when value="its" />
      </conditional>  
  </inputs>
  
  <outputs>
    <data name="seqdb_sequences_fasta" format="fasta" from_work_dir="seqdb_sequences.fasta" label="Sequences from SeqDB">
	<filter>pull_type_cond['pull_type']!="raw" or (pull_type_cond['pull_type']=="raw" and pull_type_cond['return_type_cond']['return_type']=="fasta")</filter>
    </data>
    <data name="seqdb_sequences_fastq" format="fastq" from_work_dir="seqdb_sequences.fastq" label="Sequences from SeqDB">
	<filter>pull_type_cond['pull_type']=="raw" and pull_type_cond['return_type_cond']['return_type']=="fastq"</filter>
    </data>
    <data name="seqdb_taxonomy_file" format="txt" from_work_dir="seqdb_taxonomy_file.txt" label="Taxonomy file for SeqDB sequences">
        <filter>pull_type_cond['output_taxonomy']</filter> 
    </data>
  </outputs>

  <tests>
    <test>
      <output name="out_file" file="seqdb_sequences.fasta" />
    </test>
  </tests>

  <help>
Required fields are marked with a * .

--------

@HELP__AUTHORS@

--------

.. class:: warningmark

**Execution time**: Some combination of parameters may result in a long execution time. Depending on the number of sequences that are associated with supplied API key, loading "Raw Sequences" without specifying any of the filters could take a long time. Also, requesting a taxonomy file ("Output taxonomy file") will also impact execution time.

--------

@HELP__WHAT_IT_DOES@

The tool fetches different types of sequences from Sequence DB and writes them to a fasta file.

--------

@HELP__TOOL_PARAMS@
@HELP__CONFIG_FILE_PARAM@
    
**Output taxonomy file?** when selected, the tool will produce a taxonomy file to complement a fasta sequence file. The taxonomy is extracted from SeqDB and is an accepted taxonomic determination of a specimen, which contains requested sequence. 
  </help>

</tool>
