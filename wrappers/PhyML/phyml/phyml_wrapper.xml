<?xml version="1.0"?>
<tool id="phyml_wrapper" name="PhyML" version="1.0">
        <description> Estimates maximum likelihood phylogenies from alignments of nucleotide or amino-acid sequences </description>

        <requirements>
            <requirement type="package" version="3.1">phyml</requirement>
        </requirements>

        <command>
	<![CDATA[
                filename=./`basename $seq_file_name` &&
                
		cp $seq_file_name \$filename &&
                
		phyml -i \$filename

		-d "$sequences.data_type"
		#if $sequences.data_type == "nt"
			-m "$sequences.ts_tv_selection.model_name"
			#if $sequences.ts_tv_selection.model_name == "HKY85"
				-t "$sequences.ts_tv_selection.ts_tv_ratio"
			#else if $sequences.ts_tv_selection.model_name == "K80"
				-t "$sequences.ts_tv_selection.ts_tv_ratio" 
			#else if $sequences.ts_tv_selection.model_name == "TN93"
				-t "$sequences.ts_tv_selection.ts_tv_ratio"
			#end if
		#end if		
		#if $sequences.data_type == "nt"
			-f "$sequences.eq_freq"
		#end if 
		#if $sequences.data_type == "aa"
			-m "$sequences.model_name"	  
		#end if
		#if $sequences.data_type == "aa"
			-f "$sequences.eq_freq"
		#end if
	
		-v "$prop_invar_selector.prop_invar"
		#if $prop_invar_selector.prop_invar == "f"
			-e "$prop_invar_selector.prop_invar_fixed"
		#end if 

		-a "$gamma_selector.gamma"
		#if $gamma_selector.gamma == "f"
			-j "$gamma_selector.gamma_fixed"
		#end if
		
		-b "$bootstrap_selector.bootstrap"
		#if $bootstrap_selector.bootstrap == "one"
			-g "$bootstrap_selector.num_bootstrap"
		#end if
		
		-s "$seq_file"
		
		-n "$nb_data_sets"
	
		-c "$nb_subst_cat"   
 
		-u "$user_tree_file" &&
		
		cp \${filename}_phyml_tree.txt $phyml_tree &&
		
		cp \${filename}_phyml_stats.txt $phyml_stats
       	]]>
	</command>

        <inputs>
                <param name="seq_file_name" type="data" label="Sequences" help="PHYLIP format"/>

		<param name="seq_file" type="select" label="Sequence File">
			<option value="i"> Interleaved </option>
			<option value="s"> Sequential </option>
		</param>

		<param name="nb_data_sets" type="integer" value="1" label="Number of Data Sets"/>

		<conditional name="sequences">
			<param name="data_type" type="select" label="Data Type">
				<option value="nt"> DNA </option>
				<option value="aa"> Amino-Acids </option>
			</param>
			<when value="nt">
				<conditional name="ts_tv_selection">
					<param name="model_name" type="select" label="Substitution Model">
						<option value="HKY85"> HKY85 </option>
						<option value="JC69"> JC69 </option>
						<option value="K80"> K80 </option>
						<option value="F81"> F81 </option>
						<option value="F84"> F84 </option>
						<option value="TN93"> TN93 </option>
						<option value="GTR"> GTR </option>
					</param>
					<when value="HKY85">
						<param name="ts_tv_ratio" type="select" label="Transition/Transversion Ratio" help="For DNA Models under K80, HK85 or TN93">
							<option value="e"> Maximum Likelihood Estimate </option>							
							<option value="f"> Fixed </option>
						</param>
					</when>
					<when value="JC69" />
					<when value="K80">
						 <param name="ts_tv_ratio" type="select" label="Transition/Transversion Ratio" help="For DNA Models under K80, HK85 or TN93">
							<option value="e"> Maximum Likelihood Estimate </option>							
							<option value="f"> Fixed </option>
						</param>
					</when>
					<when value="F81" />
					<when value="F84" />
					<when value="TN93">
						 <param name="ts_tv_ratio" type="select" label="Transition/Transversion Ratio" help="For DNA Models under K80, HK85 or TN93">
							<option value="e"> Maximum Likelihood Estimate </option>							
							<option value="f"> Fixed </option>
						</param>
					</when>
					<when value="GTR" />
				</conditional>
				<param name="eq_freq" type="select" label="Equilibrium Frequencies">
					<option value="m"> ML </option>
					<option value="e"> Empirical </option>
				</param>
			</when>
			<when value="aa">
				<param name="model_name" type="select" label="Subsitution Model">
					<option value="LG"> LG </option>
					<option value="BLOSUM"> Blosum62 </option>
					<option value="CpREV"> CpREV </option>
					<option value="Dayhoff"> Dayhoff </option>
					<option value="DCMut"> DCMut </option>
					<option value="FLU"> FLU </option>
					<option value="HIVb"> HIVb </option>
					<option value="HIVw"> HIVw </option>
					<option value="JIT"> JIT </option>
					<option value="MtArt"> MtArt </option>
					<option value="MtMam"> MtMam </option>
					<option value="MtREV"> MtREV </option>
					<option value="RtREV"> RtREV </option>
					<option value="VT"> VT </option>
					<option value="WAG"> WAG </option>
				</param>
				<param name="eq_freq" type="select" label="Equilibrium Frequencies">
					<option value="m"> Model </option>
					<option value="e"> Empirical </option>		
				</param>
			</when>
		</conditional>

		 <conditional name="prop_invar_selector">
			<param name="prop_invar" type="select" label="Proportion of Invariable Sites">
				<option value="e"> Maximum Likelihood Estimate </option>
				<option value="f"> Fixed </option>
			</param>
			<when value="e">
			</when>
			<when value="f">
				<param name="prop_invar_fixed" label="Fixed Value" type="integer" value="0" help="Range [0,1]" />
			</when>
		</conditional>
		
		<param name="nb_subst_cat" type="integer" value="4" label="Number of Substitution Rate Categories"/>

		<conditional name="gamma_selector">
			<param name="gamma" type="select" label="Gamma Shape Parameter">
				<option value="e"> Maximum Likelihood Estimate </option>
				<option value="f"> Fixed </option>
			</param>
			<when value="e"/>
			<when value="f">
				<param name="gamma_fixed" label="Gamma Shape Parameter Fixed by User" type="integer" value="1"/>
			</when>
		</conditional>
	
		<!-- Option to upload several files? Also, how to set default to Bionj?-->
		<param name="user_tree_file" label="Starting Tree" type="data" />

		<conditional name="bootstrap_selector">
			<param name="bootstrap" type="select" label="Bootstrap">
				<option value="one"> Number of Bootstrap Replicates </option>
				<option value="zero"> Neither approximate likelihood ratio test nor bootstrap values are computed </option>
				<option value="minus_one"> Approximate likelihood ratio test retruning aLRT statistics </option>
				<option value ="minus_two"> Approximate likelihood ratio test returning Chi2-based parametric branch supports </option>
				<option value="minus_four"> SH-like branch supports alone </option> 
			</param>
			<when value="one">
				<param name="num_bootstrap" label="Number of Bootstrap Replicates" type="integer" value="1" />
			</when>
			<when value="zero">
			</when>
			<when value="minus_one">
			</when>
			<when value="minus_two">
			</when>
			<when value="minus_four">
			</when>
		</conditional>
	

        </inputs>

        <outputs>
                <data name="phyml_tree"
                      format="txt" 
                      label="PhyML Tree"/>
                <data name="phyml_stats"
                      format="txt" 
                      label="PhyML Stats"/>
        </outputs>
</tool>

