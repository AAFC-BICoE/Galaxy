<?xml version="1.0"?>
<tool id="phyml_wrapper" name="PhyML" version="1.0">
        <description> Estimates maximum likelihood phylogenies from alignments of nucleotide or amino-acid sequences </description>

        <requirements>
            <requirement type="package" version="3.1">phyml</requirement>
        </requirements>

        <command>
	<![CDATA[
                filename=./`basename $seq_file_name` &&
                
		cp $seq_file_name \$filename &&
                
		phyml -i \$filename

		-d "$sequences.data_type"
		#if $sequences.data_type == "nt"
			-m "$sequences.ts_tv_selection.model_name"
			#if $sequences.ts_tv_selection.model_name == "HKY85"
				-t "$sequences.ts_tv_selection.ts_tv_ratio"
			#else if $sequences.ts_tv_selection.model_name == "K80"
				-t "$sequences.ts_tv_selection.ts_tv_ratio" 
			#else if $sequences.ts_tv_selection.model_name == "TN93"
				-t "$sequences.ts_tv_selection.ts_tv_ratio"
			#end if
		#end if		
		#if $sequences.data_type == "nt"
			-f "$sequences.eq_freq"
		#end if 
		#if $sequences.data_type == "aa"
			-m "$sequences.model_name"	  
		#end if
		#if $sequences.data_type == "aa"
			-f "$sequences.eq_freq"
		#end if

	
		#if $prop_invar_selector.prop_invar == "f"
			-v "$prop_invar_selector.prop_invar_fixed"
		#else
			-v "$prop_invar_selector.prop_invar"
		#end if


		#if $gamma_selector.gamma == "f"
			-a "$gamma_selector.gamma_fixed"
		#else
			-a "$gamma_selector.gamma"
		#end if

		
		#if $bootstrap_selector.bootstrap == "1"
			-b "$bootstrap_selector.num_bootstrap"				
		#else 
			-b "$bootstrap_selector.bootstrap"
		#end if


		-o "$optimise_selector.optimise"
		#if $optimise_selector.optimise == "tlr"
			-s "$optimise_selector.move"
		#else if $optimise_selector.optimise == "tl"
			-s "$optimise_selector.move"
		#end if

		
		#if $seq_file_selector.seq_file == "s"
			-q 
		#end if

		#if $tree_searching.user_tree_file == "upload"
			-u "$tree_searching.tree_file_name"                         
		#end if
		
		-n "$nb_data_sets"
	
		-c "$nb_subst_cat" &&
		
		cp \${filename}_phyml_tree.txt $phyml_tree &&
		
		cp \${filename}_phyml_stats.txt $phyml_stats
	
		#if $bootstrap_selector.bootstrap == "1"
			&& cp \${filename}_phyml_boot_trees.txt $phyml_boot_trees &&
			cp \${filename}_phyml_boot_stats.txt $phyml_boot_stats
		#end if
       	]]>
	</command>

        <inputs>
                <param name="seq_file_name" type="data" label="Sequences" help="PHYLIP format"/>

		<conditional name="seq_file_selector">
			<param name="seq_file" type="select" label="Sequence File">
				<option value="i"> Interleaved </option>
				<option value="s"> Sequential </option>
			</param>
			<when value="i" />
			<when value="s" />
		</conditional>

		<param name="nb_data_sets" type="integer" value="1" label="Number of Data Sets"/>

		<conditional name="sequences">
			<param name="data_type" type="select" label="Data Type">
				<option value="nt"> DNA </option>
				<option value="aa"> Amino-Acids </option>
			</param>
			<when value="nt">
				<conditional name="ts_tv_selection">
					<param name="model_name" type="select" label="Substitution Model">
						<option value="HKY85"> HKY85 </option>
						<option value="JC69"> JC69 </option>
						<option value="K80"> K80 </option>
						<option value="F81"> F81 </option>
						<option value="F84"> F84 </option>
						<option value="TN93"> TN93 </option>
						<option value="GTR"> GTR </option>
					</param>
					<when value="HKY85">
						<param name="ts_tv_ratio" type="select" label="Transition/Transversion Ratio" help="For DNA Models under K80, HK85 or TN93">
							<option value="e"> Maximum Likelihood Estimate </option>							
							<option value="f"> Fixed </option>
						</param>
					</when>
					<when value="JC69" />
					<when value="K80">
						 <param name="ts_tv_ratio" type="select" label="Transition/Transversion Ratio" help="For DNA Models under K80, HK85 or TN93">
							<option value="e"> Maximum Likelihood Estimate </option>							
							<option value="f"> Fixed </option>
						</param>
					</when>
					<when value="F81" />
					<when value="F84" />
					<when value="TN93">
						 <param name="ts_tv_ratio" type="select" label="Transition/Transversion Ratio" help="For DNA Models under K80, HK85 or TN93">
							<option value="e"> Maximum Likelihood Estimate </option>							
							<option value="f"> Fixed </option>
						</param>
					</when>
					<when value="GTR" />
				</conditional>
				<param name="eq_freq" type="select" label="Equilibrium Frequencies">
					<option value="m"> ML </option>
					<option value="e"> Empirical </option>
				</param>
			</when>
			<when value="aa">
				<param name="model_name" type="select" label="Subsitution Model">
					<option value="LG"> LG </option>
					<option value="BLOSUM"> Blosum62 </option>
					<option value="CpREV"> CpREV </option>
					<option value="Dayhoff"> Dayhoff </option>
					<option value="DCMut"> DCMut </option>
					<option value="FLU"> FLU </option>
					<option value="HIVb"> HIVb </option>
					<option value="HIVw"> HIVw </option>
					<option value="JIT"> JIT </option>
					<option value="MtArt"> MtArt </option>
					<option value="MtMam"> MtMam </option>
					<option value="MtREV"> MtREV </option>
					<option value="RtREV"> RtREV </option>
					<option value="VT"> VT </option>
					<option value="WAG"> WAG </option>
				</param>
				<param name="eq_freq" type="select" label="Equilibrium Frequencies">
					<option value="m"> Model </option>
					<option value="e"> Empirical </option>		
				</param>
			</when>
		</conditional>

		 <conditional name="prop_invar_selector">
			<param name="prop_invar" type="select" label="Proportion of Invariable Sites">
				<option value="e"> Maximum Likelihood Estimate </option>
				<option value="f"> Fixed </option>
			</param>
			<when value="e">
			</when>
			<when value="f">
				<param name="prop_invar_fixed" label="Fixed Value" type="float" value="0" help="Range [0,1]" />
			</when>
		</conditional>
		
		<param name="nb_subst_cat" type="integer" value="4" label="Number of Substitution Rate Categories"/>

		<conditional name="gamma_selector">
			<param name="gamma" type="select" label="Gamma Shape Parameter">
				<option value="e"> Maximum Likelihood Estimate </option>
				<option value="f"> Fixed </option>
			</param>
			<when value="e"/>
			<when value="f">
				<param name="gamma_fixed" label="Gamma Shape Parameter Fixed by User" type="integer" value="1"/>
			</when>
		</conditional>
	
		<conditional name="tree_searching">
			<param name="user_tree_file" type="select" label="Starting Tree(s): Upload file?"> 
				<option value="upload"> Yes, Upload File </option>
				<option value="bionj"> BIONJ </option>		
			</param>
			<when value="upload">
				<param name="tree_file_name" label="Upload the file" type="data" />
			</when>
			<when value="bionj">	
			</when>
		</conditional> 

		<conditional name="optimise_selector">
			<param name="optimise" type="select" label="Optimise Starting Tree(s) options">
				<option value="tlr"> Tree topology, Branch Lengths, Rate Parameters </option>
				<option value="tl"> Tree topology, Branch Lengths </option>
				<option value="lr"> Branch Lengths, Rate Parameters </option>
				<option value="l"> Branch Lengths </option>
				<option value="r"> Rate Parameters </option>
				<option value="n"> No paramater is optimised </option> 
			</param>
			<when value="tlr">
				<param name="move" type="select" label="Topology Search Operation">
					<option value="NNI"> NNI </option>
					<option value="SPR"> SPR </option>
					<option value="BEST"> BEST </option>
				</param>
			</when>
			<when value="tl">
				<param name="move" type="select" label="Topology Search Operation">
					<option value="NNI"> NNI </option>
					<option value="SPR"> SPR </option>
					<option value="BEST"> BEST </option>
				</param>
			</when>
			<when value="lr">
			</when>
			<when value="l">
			</when>
			<when value="r">
			</when>
			<when value="n">
			</when>
		</conditional>

		<conditional name="bootstrap_selector">
			<param name="bootstrap" type="select" label="Bootstrap">
				<option value="1"> Number of Bootstrap Replicates </option>
				<option value="0"> Neither approximate likelihood ratio test nor bootstrap values are computed </option>
				<option value="-1"> Approximate likelihood ratio test retruning aLRT statistics </option>
				<option value ="-2"> Approximate likelihood ratio test returning Chi2-based parametric branch supports </option>
				<option value="-4"> SH-like branch supports alone </option> 
			</param>
			<when value="1">
				<param name="num_bootstrap" label="Number of Bootstrap Replicates" type="integer" value="1" />
			</when>
			<when value="0">
			</when>
			<when value="-1">
			</when>
			<when value="-2">
			</when>
			<when value="-4">
			</when>
		</conditional>
	

        </inputs>

        <outputs>
                <data name="phyml_tree" format="txt" label="PhyML Tree"/>
                <data name="phyml_stats" format="txt" label="PhyML Stats"/>
		<data name="phyml_boot_trees" format="txt" label="PhyML Bootstrap Tree">
    			<filter>bootstrap_selector['bootstrap'] == "1"</filter> 
		</data>
		<data name="phyml_boot_stats" format="txt" label="PhyML Bootstrap Stats">
		    <filter>bootstrap_selector['bootstrap'] == "1"</filter> 
		</data>
        </outputs>

	<stdio>
	    <exit_code range="1:"   level="fatal"   description="The tool's exit code was 1, which suggests that something went wrong." />
	</stdio>
        
</tool>

