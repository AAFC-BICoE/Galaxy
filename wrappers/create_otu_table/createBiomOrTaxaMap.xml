<tool id="createBiomOrTaxaMap" name="Create OTU Table" version="1.0">

	<description> 
		Takes a cluster mapping file and lca file and generates an classic otu table.
		Also able to generate a taxa mapping file with only lca file.
	</description>

	<stdio>
		<exit_code range="1:" level="fatal" description="Error"/>
	</stdio>

	<command interpreter="perl">
	createBiomOrTaxaMap.pl 
		-l $lca
		$names 
		$taxamap
		#if $taxasource.source.__str__ == "locfile":
			--taxa-dir $taxasource.taxonomydisk.fields.path
		#elif $taxasource.source.__str__ == "history":
			--taxa-dir $taxasource.taxadump
		#end if
		#if $clustermapcond.clustermapselect.__str__ == "yes":
		-m $clustermapcond.clustermap
		#end if
		#if $filter.filterflag.__str__ == "yes":
			#if float($filter.qcover.__str__) != -1:
				--query-cover=$filter.qcover
			#end if
			#if float($filter.pid.__str__) != -1:
				--pid=$filter.pid
			#end if
			#if float($filter.evalue.__str__) != -1:
				--evalue=$filter.evalue
			#end if
		#end if
		#if $advanced.advancedoptions.__str__ == "yes":
			$advanced.fulllineage
			$advanced.nosamplecounts
			$advanced.totalcounts
			$advanced.representative
		#end if
	</command>

	<inputs>
		<param name="lca" type="data" label="lca file"/>

		<conditional name="clustermapcond">
			<param name="clustermapselect" type="select" label="cluster mapping">
				<option value="yes">Cluster Mapping File</option>
				<option value="no">No Cluster Mapping File</option>
			</param>
			<when value="yes">
				<param name="clustermap" type="data" label="cluster mapping file"/>
			</when>
		</conditional>

		<param name="names" type="boolean" truevalue="--names" falsevalue="" label="use namesotu (default: qiimeotu)"/> 

		<param name="taxamap" type="boolean" truevalue="--taxa-map" falsevalue="" label="taxa mapping file"/>

		<conditional name="taxasource">
			<param name="source" type="select" label="taxonomy source">
				<option value="locfile">From Local Database</option>
				<option value="history">From Galaxy History</option>
			</param>
			<when value="locfile">
				<param name="taxonomydisk" type="select" label="taxonomy database">
					<options from_file="lca_taxonomydb.loc">
						<column name="value" index="0"/>
						<column name="name" index="1"/>
						<column name="path" index="2"/>
					</options>
				</param>
			</when>
			<when value="history">
				<param name="taxadump" type="data" label="taxonomy dump"/>
			</when>
		</conditional>

		<conditional name="filter">
			<param name="filterflag" type="select" label="specify filters">
				<option value="no">No Filters</option>
				<option value="yes">Specify Filters</option>
			</param>
			<when value="yes">
				<param name="qcover" type="float" value="-1" label="filter on qcover (set to -1 to ignore)"/> 
				<param name="pid" type="float" value="-1" label="filter on pid (set to -1 to ignore)"/> 
				<param name="evalue" type="float" value="-1" label="filter on evalue (set to -1 to ignore)"/> 
			</when>
		</conditional>
	
		<conditional name="advanced">
			<param name="advancedoptions" type="select" label="advanced options">
				<option value="no">Do Not Show Advanced Options</option>
				<option value="yes">Show Advanced Options</option>
			</param>
			<when value="yes">
				<param name="fulllineage" type="boolean" truevalue="--full-taxa" falsevalue="" label="shows full lineage with ranks"/> 
				<param name="nosamplecounts" type="boolean" truevalue="--no-sample-counts" falsevalue="" label="no sample counts"/> 
				<param name="totalcounts" type="boolean" truevalue="--total-counts" falasevalue="" label="only total counts"/> 
				<param name="representative" type="boolean" truevalue="--representative" falsevalue="" label="show representative"/> 
			</when>
		</conditional>	
	</inputs>

	<outputs>
		<data name="output" format="tabular" label="OTU Table" from_work_dir="otu_table.tab">
			<filter>taxamap is False</filter>
		</data>
		<data name="outscrap" format="tabular" label="Scrap OTU Table" from_work_dir="otu_table.tab.scrap">
			<filter>filter['filterflag'] is True</filter>
		</data>
		<data name="mapout" format="tabular" label="Taxa Mapping File" from_work_dir="otu_table.map">
			<filter>taxamap is True</filter>
  		</data>
	</outputs>

	<tests>
		<test>
			<param name="lca" value="input_LCA_Results.tabular"/>
			<param name="clustermapselect" value="yes"/>
			<param name="clustermap" value="input_QIIME_OTU_mapping.tabular"/>
			<param name="names" value="false"/>
			<param name="taxamap" value="false"/>
			<param name="source" value="locfile"/> 
			<param name="taxonomydisk" value="ncbi_taxonomy"/>
			<param name="filterflag" value="no"/>
			<param name="advancedoptions" value="no"/>
			<output name="output" file="output_OTU_Table.tabular"/>
		</test>
	</tests>

	<help>
**Description**

This tool generates a classic OTU table or a taxonomy mapping file using
	
	* **lca** file format generated by findLCA.pl
	* **qiimeotu**, **namesotu** files generated by createClusterMap.pl

.. class:: warningmark

To use the namesotu file please check the use namesotu option.

It also contains some options to filter down or print certain columns of these two files.

.. class:: warningmark

Only usable on the Classic OTU Table 

.. class:: infomark

A custom Taxonomy database can be generated by create_custom_taxa.

1) Classic OTU Table
	
	* By default will produce the classic otu table. 
	* Any of the optional params can be used with it. 
	* It also provides the ability to filter based on the evalue, pid or query-cover of the lca identifications.

.. class:: warningmark

Please check the taxa mapping file for this option

2) Taxonomy Mapping
	
	* To produce the taxa-map file no cluster mapping file only the .lca file. 
	* None of the filter or optional params can be used, if specified they will be ignored.

----- 

**Author**

- Create Cluster Map Script and Wrapper:
	+ Script Name:createBiomOrTaxaMap.pl
	+ Wrapper Name: createBiomOrTaxaMap.xml
	+ Christopher Lewis, Johnny Zhang, Nan Zhang
	+ Agriculture and Agri-food Canada, Ottawa, ON, Canada

-----

**References**

AAFC-AAC Bioinformatics
	</help>
</tool>
