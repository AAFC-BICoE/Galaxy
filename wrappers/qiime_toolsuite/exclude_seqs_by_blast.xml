<?xml version="1.0" ?>
<tool id="exclude_seqs_by_blast" name="exclude seqs by blast" version="1.7.0">
	<description>Exclude contaminated sequences using BLAST</description>
	<requirements>
<requirement type="package" version="1.7.0">qiime</requirement>	</requirements>
	<command>uncompress_tgz.py -i $blastmatroot -o exclude_seqs_by_blast_input;
exclude_seqs_by_blast.py -i $querydb -d $subjectdb -o exclude_seqs_by_blast_output
#if $e_value:
 -e $e_value
#end if

#if $percent_aligned:
 -p $percent_aligned
#end if

#if $no_clean:
 --no_clean
#end if
 --blastmatroot=exclude_seqs_by_blast_input
#if $max_hits:
 -m $max_hits
#end if

#if $word_size:
 -w $word_size
#end if

#if $no_format_db:
 -n
#end if
;
compress_path.py -i exclude_seqs_by_blast_output -o $outputdir
</command>
	<inputs>
		<param default="None" label="-i/--querydb: The path to a FASTA file containing query sequences" name="querydb" optional="False" type="data"/>
		<param default="None" label="-d/--subjectdb: The path to a FASTA file to BLAST against" name="subjectdb" optional="False" type="data"/>
		<param default="1e-10" label="-e/--e_value: The e-value cutoff for blast queries [default: 1e-10]." name="e_value" optional="True" type="float"/>
		<param default="0.97" label="-p/--percent_aligned: The % alignment cutoff for blast queries [default: 0.97]." name="percent_aligned" optional="True" type="float"/>
		<param label="--no_clean: If set, don't delete files generated by formatdb after running [default: False]." name="no_clean" selected="False" type="boolean"/>
		<param label="--blastmatroot: Path to a folder containing blast matrices [default: None]." name="blastmatroot" type="data"/>
		<param default="100" label="-m/--max_hits: Max hits parameter for BLAST. CAUTION: Because filtering on alignment percentage occurs after BLAST, a max hits value of 1 in combination with an alignment percent filter could miss valid contaminants. [default: 100]" name="max_hits" optional="True" type="integer"/>
		<param default="28" label="-w/--word_size: Word size to use for BLAST search [default: 28]" name="word_size" optional="True" type="integer"/>
		<param label="-n/--no_format_db: If this flag is specified, format_db will not be called on the subject database (formatdb will be set to False).  This is  useful if you have already formatted the database and a) it took a very long time or b) you want to run the script in parallel on the pre-formatted database [default: False]" name="no_format_db" selected="False" type="boolean"/>
	</inputs>
	<outputs>
		<data format="tgz" name="outputdir"/>
	</outputs>
	<help>

This code is designed to allow users of the QIIME workflow to conveniently exclude unwanted sequences from their data. This is mostly useful for excluding human sequences from runs to comply with Internal Review Board (IRB) requirements, but may also have other uses (e.g. perhaps excluding a major bacterial contaminant). Sequences from a run are searched against a user-specified subject database, where BLAST hits are screened by e-value and the percentage of the query that aligns to the sequence.

For human screening THINK CAREFULLY about the data set that you screen against. Are you excluding human non-coding sequences? What about mitochondrial sequences? This point is CRITICAL because submitting human sequences that are not IRB-approved is BAD.

(e.g. you would NOT want to just screen against just the coding sequences of the human genome as found in the KEGG .nuc files, for example)

One valid approach is to screen all putative 16S rRNA sequences against greengenes to ensure they are bacterial rather than human.

WARNING: You cannot use this script if there are spaces in the path to the database of fasta files because formatdb cannot handle these paths (this is a limitation of NCBI's tools and we have no control over it).

Four output files are generated based on the supplied outputpath + unique suffixes:

1. &quot;filename_prefix&quot;.matching: A FASTA file of sequences that did pass the screen (i.e. matched the database and passed all filters).

2. &quot;filename_prefix&quot;.non-matching: A FASTA file of sequences that did not pass the screen.

3. &quot;filename_prefix&quot;.raw_blast_results: Contains the raw BLAST results from the screening.

4. &quot;filename_prefix&quot;.sequence_exclusion_log: A log file summarizing the options used and results obtained.

In addition, if the --no_clean option is passed, the files generated by formatdb will be kept in the same directory as subjectdb.
</help>
</tool>
