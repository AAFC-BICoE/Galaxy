<?xml version="1.0"?>
<tool id="phyml_wrapper" name="PhyML" version="1.0">
	<description> Estimates maximum likelihood phylogenies from alignments of nucleotide or amino-acid sequences </description>
	
	<requirements>
	    <requirement type="package" version="3.1">phyml</requirement>
	</requirements>
	
	<command>
		phyml -i "$seq_file_name" -d "$data_type" -q "$seq_file" -m "$model_name" -f "$eq_freq" -t "$ts_tv_ratio" -n "$nb_data_sets" -v "$prop_invar" -c "$nb_subst_cat" -a "$gamma_shape" -g "$num_gamma_shape" -u "$user_tree_file" -w "$tree_file_name" -k "$opt_topology" -l "$opt_branch_lengths" -s "$tree_imp" -p "$fast_likelihood_based_method" -e "$method" -b "$bootstrap" -e "$num_bootstrap" -o "$output1" -out "$output2"
	</command> 
	
	<inputs>
		<param format="phylip" name="seq_file_name" type="data" label="Sequences" help="PHYLIP format"/>
		
		<conditional name="sequences">
			<param name="data_type" type="select" label="Data Type">
				<option value="nt"> DNA </option>
				<option value="aa"> Amino-Acids </option>
			</param>
			<when value="nt">
				<conditional name="ts_tv_selection">
					<param name="model_name" type="select" label="Substitution Model">
						<option value="hky"> HKY85 </option>
						<option value="jc"> JC69 </option>
						<option value="k"> K80 </option>
						<option value="f"> F81 </option>
						<option value="ff"> F84 </option>
						<option value="tn"> TN93 </option>
						<option value="gtr"> GTR </option>
					</param>
					<when value="hky">
						<param name="ts_tv_ratio" type="select" label="Transition/Transversion Ratio" help="For DNA Models under K80, HK85 or TN93">
							<option value="ts_tv_fixed"> Fixed </option>
							<option value="ts_tv_estimated"> Estimated </option>
						</param>
					</when>
					<when value="jc" />
					<when value="k"> 
						<param name="ts_tv_ratio" type="select" label="Transition/Transversion Ratio" help="For DNA Models under K80, HK85 or TN93">
							<option value="ts_tv_fixed"> Fixed </option>
							<option value="ts_tv_estimated"> Estimated </option>
						</param>
					</when>
					<when value="f" />
					<when value="ff"> 
						<param name="ts_tv_ratio" type="select" label="Transition/Transversion Ratio" help="For DNA Models under K80, HK85 or TN93">
							<option value="ts_tv_fixed"> Fixed </option>
							<option value="ts_tv_estimated"> Estimated </option>
						</param>
					</when>
					<when value="tn" />
					<when value="gtr" />
				</conditional>
				<param name="eq_freq" type="select" label="Equilibrium Frequencies">
					<option value="eq_freq_optimized"> Optimized </option>
					<option value="eq_freq_empirical"> Empirical </option>
				</param>
			</when>
			<when value="aa">
				<param name="model_name" type="select" label="Subsitution Model">
					<option value="lg"> LG </option>
					<option value="blosum"> Blosum62 </option>
					<option value="cprev"> CpREV </option>
					<option value="dayhoff"> Dayhoff </option>
					<option value="dcmut"> DCMut </option>
					<option value="flu"> FLU </option>
					<option value="hivb"> HIVb </option>
					<option value="hivw"> HIVw </option>
					<option value="jit"> JIT </option>
					<option value="mtart"> MtArt </option>
					<option value="mtmam"> MtMam </option>
					<option value="mtrev"> MtREV </option>
					<option value="rtrev"> RtREV </option>
					<option value="vt"> VT </option>
					<option value="wag"> WAG </option>
				</param>
				<param name="eq_freq" type="select" label="Equilibrium Frequencies">
					<option value="eq_freq_model"> Model </option>
					<option value="eq_freq_empirical"> Empirical </option> 
				</param>
			</when>
		</conditional>
		
		<param name="seq_file" type="select" label="Sequence File">
			<option value="i"> Interleaved </option>
			<option value="s"> Sequential </option>
		</param>
		
		<param name="nb_data_sets" type="integer" value="1" label="Number of Data Sets"/> 
		
		<param name="prop_invar" type="select" label="Proportion of Invariable Sites">
			<option value="prop_ivar_fixed"> Fixed </option>
			<option value="prop_invar_estimated"> Estimated </option>
		</param>
		
		<param name="nb_subst_cat" type="integer" value="4" label="Number of Substitution Rate Categories"/> 
		
		<conditional name="gamma">
			<param name="gamma_shape" type="select" label="Gamma Shape Parameter">
				<option value="gamma_fixed"> Fixed </option>
				<option value="gamma_estimated"> Estimated </option>
			</param>
			<when value="gamma_fixed">
				<!--  Galaxy insists that there must be a value setting with a default value.  -->
				<param name="num_gamma_shape" label="Gamma Shape Parameter Fixed by User" type="integer" value="1"/>
			</when>
			<when value="gamma_estimated" />
		</conditional> 
		
		<conditional name="tree_searching">
			<param name="user_tree_file" type="select" label="Starting Tree(s)">
				<option value="tree_file"> Upload File </option>
				<option value="tree_bionj"> BIONJ </option>
			</param>
			<when value="tree_file">
				<param name="tree_file_name" label="Upload the file" type="data" />
			</when>
			<when value="tree_bionj" />
		</conditional>

		<conditional name="topology"> 
			<param name="opt_topology" type="select" label="Optimise Topology">
				<option value="opt_topology_y"> Yes </option>
				<option value="opt_topology_n"> No </option>
			</param> 
			<when value="opt_topology_y">
				<param name="opt_branch_lengths" type="select" label="Optimise Branch Lengths">
					<option value="opt_branch_lengths_y"> Yes </option>
				</param>
				<param name="tree_imp" type="select" label="Type of Tree Improvement">
					<option value="tree_imp_nni"> NNI </option>
					<option value="tree_imp_spr"> SPR </option>
					<option value="tree_imp_both"> SPR and NNI </option>
				</param> 
			</when>
			<when value="opt_topology_n">
				<param name="opt_branch_lengths" type="select" label="Optimise Branch Lengths">
					<option value="opt_branch_lengths_y"> Yes </option>
					<option value="opt_branch_lengths_n"> No </option>
				</param>
			</when>
		</conditional> 
		
		<conditional name="branch_support">
			<param name="fast_likelihood_based_method" type="select" label="Fast Likelihood-Based Method">
				<option value="branch_support_y"> Yes </option>
				<option value="branch_support_n"> No </option>
			</param>
			<when value="branch_support_y">
				<param name="method" label="Method" type="select">
					<option value="alrt_sh_like"> aLRT SH-Like </option>
					<option value="alrt_chi2_based"> aLRT Chi2-Based </option>
					<option value="abayes"> aBayes </option>
				</param>	
			</when>
			<when value="branch_support_n">
				<conditional name="perform_bootstrap">
					<param name="bootstrap" type="select" label="Perform Bootstrap">
						<option value="bootstrap_y"> Yes </option>
						<option value="bootstrap_n"> No </option>
					</param>
					<when value="bootstrap_y">
						<param name="num_bootstrap" label="Bootsratp Number" type="integer" value="100" />
					</when>
					<when value="bootstrap_n" />
				</conditional> 
			</when>
		</conditional> 
	</inputs>
	
	<outputs>
		<!-- There are two outputs missing. These two outputs depend on whether bootstrap was used or not.  -->
		<data format="txt" name="output1" label="${tool.name} on ${on_string}: PhyML" />
		<data format="txt" name="output2" label="${tool.name} on ${on_string}: PhyML"/>
	</outputs>
	
	<tests>
	    <test>
	        <param name="seq_file_name" value="test.phy" />
	        <param name="data_type" value="nt" />
	        <param name="model_name" value="hky" />
	        <param name="ts_tv_ratio" value="ts_tv_estimated" />
	        <param name="eq_freq" value="eq_freq_optimized" />
	        <param name="seq_file" value="s" />
	        <param name="nb_data_sets" value="1" />
	        <param name="prop_invar" value="prop_invar_estimated" />
	        <param name="nb_subst_cat" value="4" />
	        <param name="gamma_shape" value="gamma_estimated" />
	        <!-- <param name="num_gamma_shape" value="" />  -->
	        <param name="user_tree_file" value="tree_bionj" />
	        <!-- <param name="tree_file_name" value="" />  -->
	        <param name="opt_topology" value="opt_topology_y" />
	        <param name="opt_branch_lengths" value="opt_branch_lengths_y" />
	        <param name="tree_imp" value="tree_imp_both" /> 
	        <param name="fast_likelihood_based_method" value="branch_support_y" />
	        <param name="method" value="alrt_sh_like" />
	        <!-- <param name="bootstrap" value="" /> -->
	        <!-- <param name="num_bootstrap" value="" /> -->
	        <output name="output1" file="test_phyml_tree.txt" />
	        <output name="output2" file="test_phyml_stats.txt" />
	    </test>
	</tests>
	
	
	<stdio>
		<exit_code range="1:" level="fatal" description="An error occured. Check STDERR for more information." />
	</stdio>
	
	<help>
		**Tool Information**
		
		PhyML Tool v3.1
			Release Date: March 2013
			Source URL: http://www.atgc-montpellier.fr/download/binaries/phyml/PhyML-3.1.zip
		
		**Author**
		
		PhyML:
			Stephane Guindon, Olivier Gascuel, Wim Hordjik, Maria Anisimova,
			Franck Lethiec, Jean-Francois Dufayard, Vincent Lefort, Patrice Duroux 
			ATGC: PhyML - ATGC: Monpellier Bioinformatics platform
			URL: http://www.atgc-montpellier.fr/download/papers/phyml_manual_2012.pdf
		
		PhyML Galaxy Wrapper:
			Cime Ajouz
			cime.ajouz@agr.gc.ca
			Agriculture and Agri-foods Canada
			Ottawa, ON, Canada
			
		**Description**
		PhyML is a software package which primary task is to estimate maximum likelihood phylogenies from alignments of nucleotide or amino acid sequences.
		
		**Citation**
		"PhyML - Manual" Guindon S., 2012"
			
		**Inputs and Outputs**
		
		- Input:
			- Accepts alignments of DNA or protein sequences in PHYLIP sequential or interleaved format (seq_phyml_tree.txt)
			- Accepts one or several phylogenetic trees from an input file 

		- Output:
			- Tree File in Newick format (seq_phyml_tree.txt)
			- Model Parameter File (seq_phyml_stats.txt)
			- If bootsrap support were evalutated:
				- The Maximum Likelihood Trees (seq_phyml_boot_tree.txt)
				- The Substitution Model parameters estimated from each bootstrap replicate (seq_boot_phyml_stats.txt)
		
	</help>
	
</tool>

